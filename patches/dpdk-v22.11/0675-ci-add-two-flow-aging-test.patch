From 97e882852cefed6ee1448831dd226cd02c0e6568 Mon Sep 17 00:00:00 2001
From: Ankur Dwivedi <adwivedi@marvell.com>
Date: Thu, 12 Oct 2023 14:33:33 +0530
Subject: [PATCH 675/955] ci: add two flow aging test

Adds two flow aging test in flow_aging.

Signed-off-by: Ankur Dwivedi <adwivedi@marvell.com>
Change-Id: If94f41145a04c718f3bfd10052270faa44319468
Reviewed-on: https://sj1git1.cavium.com/c/IP/SW/dataplane/dpdk/+/113813
Base-Builds: sa_ip-toolkits-Jenkins <sa_ip-toolkits-jenkins@marvell.com>
Base-Tests: sa_ip-toolkits-Jenkins <sa_ip-toolkits-jenkins@marvell.com>
Tested-by: sa_ip-toolkits-Jenkins <sa_ip-toolkits-jenkins@marvell.com>
Reviewed-by: Jerin Jacob Kollanukkaran <jerinj@marvell.com>
Reviewed-on: https://sj1git1.cavium.com/c/IP/SW/dataplane/dpdk/+/115142
---
 .../cnxk-tests/flow_aging/cnxk_flow_aging.sh  |  53 ++++++++++++++++--
 .../test/cnxk-tests/flow_aging/meson.build    |   1 +
 .../pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap   | Bin 0 -> 748 bytes
 3 files changed, 50 insertions(+), 4 deletions(-)
 create mode 100644 marvell-ci/test/cnxk-tests/flow_aging/pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap

diff --git a/marvell-ci/test/cnxk-tests/flow_aging/cnxk_flow_aging.sh b/marvell-ci/test/cnxk-tests/flow_aging/cnxk_flow_aging.sh
index bc84b6e3073ad..388e2f64c1c91 100755
--- a/marvell-ci/test/cnxk-tests/flow_aging/cnxk_flow_aging.sh
+++ b/marvell-ci/test/cnxk-tests/flow_aging/cnxk_flow_aging.sh
@@ -56,17 +56,18 @@ function pktgen_send_flow()
 function testpmd_check_aging()
 {
 	local prefix=$1
+	local cnt=$2
 	local out=testpmd.out.$prefix
 
 	testpmd_cmd $prefix "flow aged 0"
 
 	sleep 3
 	testpmd_prompt $prefix
-	COUNT=`cat $out | tail -n6 | grep "total aged flows:" | cut -d':' -f2`
+	COUNT=`cat $out | tail -n7 | grep "total aged flows:" | cut -d':' -f2`
 
 	echo -e "Total aged flows:$COUNT \n"
 
-	if [[ "$COUNT" -eq "1" ]]; then
+	if [[ "$COUNT" -eq "$cnt" ]]; then
 		return 0
 	fi
 
@@ -95,9 +96,9 @@ function testpmd_test_aging()
 	pktgen_quit
 	pktgen_cleanup
 
-	sleep 30
+	sleep 40
 
-	if testpmd_check_aging $prefix; then
+	if testpmd_check_aging $prefix 1; then
 		echo "$name passed"
 		#Delete rule
 		testpmd_cmd $prefix "flow destroy 0 rule 0"
@@ -108,6 +109,44 @@ function testpmd_test_aging()
 	fi
 }
 
+function testpmd_test_aging_2flows()
+{
+	local prefix=$1
+	local name=$2
+	local flow1=$3
+	local flow2=$4
+	local pcapfile=$5
+	local in=testpmd.in.$prefix
+	echo "$cmd" >> $in
+	testpmd_prompt $prefix
+
+	#Add rule
+	testpmd_cmd $prefix "$flow1"
+	testpmd_cmd $prefix "$flow2"
+
+	testpmd_cmd $prefix "start"
+
+	pktgen_send_flow $pcapfile
+
+	sleep 3
+
+	pktgen_quit
+	pktgen_cleanup
+
+	sleep 40
+
+	if testpmd_check_aging $prefix 2; then
+		echo "$name passed"
+		#Delete rule
+		testpmd_cmd $prefix "flow destroy 0 rule 0"
+		testpmd_cmd $prefix "flow destroy 0 rule 1"
+		return 0
+	else
+		echo "$name failed"
+		exit -1
+	fi
+}
+
 echo "Testpmd running with $TESTPMD_PORT, Coremask=$TESTPMD_COREMASK"
 testpmd_launch $PRFX \
 		" -c $TESTPMD_COREMASK -a $TESTPMD_PORT" \
@@ -119,6 +158,12 @@ testpmd_test_aging $PRFX FLOW_AGING "flow create 0 ingress pattern eth / \
  vlan / ipv4 / tcp / end actions age timeout 20 / queue index 2 / count / end" \
  "pcap/eth_vlan_ipv4_tcp.pcap"
 
+testpmd_test_aging_2flows $PRFX FLOW_AGING "flow create 0 ingress pattern eth / \
+ vlan / ipv4 / tcp / end actions age timeout 20 / queue index 2 / count / end" \
+ "flow create 0 ingress pattern eth / vlan / ipv6 / tcp / end actions age \
+ timeout 20 / queue index 2 / count / end" \
+ "pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap"
+
 testpmd_quit $PRFX
 echo "SUCCESS: flow aging test completed"
 exit 0
diff --git a/marvell-ci/test/cnxk-tests/flow_aging/meson.build b/marvell-ci/test/cnxk-tests/flow_aging/meson.build
index f7309e98b5f91..32f39ef4c3455 100644
--- a/marvell-ci/test/cnxk-tests/flow_aging/meson.build
+++ b/marvell-ci/test/cnxk-tests/flow_aging/meson.build
@@ -16,6 +16,7 @@ test_dir = meson.current_build_dir()
 # Copy the required scripts to build directory.
 run_command(copy_data, test_script)
 run_command(copy_data, 'pcap/eth_vlan_ipv4_tcp.pcap')
+run_command(copy_data, 'pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap')
 
 # Add the meson test
 test(test_name,
diff --git a/marvell-ci/test/cnxk-tests/flow_aging/pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap b/marvell-ci/test/cnxk-tests/flow_aging/pcap/eth_vlan_ipv4_ipv6_tcp_2flows.pcap
new file mode 100644
index 0000000000000000000000000000000000000000..8684b0c770cde332b8406a2be55d987402f5a790
GIT binary patch
literal 748
zcmd<$<>jhjU|{gI(UxKa(*L1=nL(VvCo`|KLcvte&{WSr*VIfmJvA@2C^MOXg~6J^
zH?=4|H94_BK_fh~D782vu_#+p!C22o&sagjJ+nli48kr*OwLYBPfbxsEQZMH8fpS<
zVPF8+39?TFN;3dW1+m$HSOp{j1amI2GSo_5ZearQL3q{fGk4$pFWCA*Gor7Nfl--*
z!Ig#K1IQQ$Hvb!3+&sKoK)~$Es0`81z!1Qszz|r$z)&$v03>WcVPt_6MuNLnY!?Ia
vK^PK75dVY1sO@h02Btj>ci31J7<qTxTMG*r20=7FBYL<c9T`sH1`00#8TJH3

literal 0
HcmV?d00001

-- 
2.25.1

